name: Build iOS Nightly
on:
  workflow_dispatch:
jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 设置JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
      - name: 设置Android SDK
        uses: android-actions/setup-android@v3
      - name: 解密签名
        run: |
          echo ${{ secrets.SIGN_KEY_BASE64 }} | base64 --decode > /tmp/key.jks
          echo ${{ secrets.AG_CONNECT_JSON }} | base64 --decode > composeApp/agconnect-services.json
      - run: chmod a+x gradlew
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: 更新iOS应用版本号
        env:
          SIGN_KEY_ALIAS: ${{ secrets.SIGN_KEY_ALIAS }}
          SIGN_KEY_STORE_PASSWORD: ${{ secrets.SIGN_KEY_STORE_PASSWORD }}
          SIGN_KEY_PASSWORD: ${{ secrets.SIGN_KEY_PASSWORD }}
          SIGN_KEY_STORE_FILE: "/tmp/key.jks"
          GITHUB_USERNAME: ${{ secrets.NEXUS_USER }}
          GITHUB_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          ./gradlew composeApp:exportLibraryDefinitions
          ./gradlew composeApp:updateAppleBuildVersion
      - name: Deploy
        uses: vfrascello/xcode-deploy@v1.5
        with:
          configuration: 'Release'
          update-build: false
          install-pods: false
          resolve-package-dependencies: true
          distribution-certificate-p12: ${{ secrets.IOS_CERTIFICATE }}
          distribution-certificate-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          app-store-provisioning-profile: ${{ secrets.IOS_PROVISION_PROFILE}}
          auth-key-id: ${{ secrets.IOS_APPSTORE_API_KEY_ID }}
          auth-key-issuer-id: ${{ secrets.IOS_APPSTORE_ISSUER_ID }}
          auth-key-p8: ${{ secrets.IOS_APPSTORE_API_PRIVATE_KEY }}